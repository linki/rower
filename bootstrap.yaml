---
name: rower-{system.architecture}-{provider.virtualization}-{volume.backing}-{%Y}{%m}{%d}-{%H}{%M}
provider:
  name: ec2
  description: Rower operating system ({system.architecture} {provider.virtualization} {volume.backing}); https://github.com/sarnowski/rower
  virtualization: hvm
  enhanced_networking: simple
  install_init_scripts: false
bootstrapper:
  workspace: /target
  tarball: true  # dev only
system:
  release: jessie
  architecture: amd64
  bootloader: grub
  charmap: UTF-8
  locale: en_US
  timezone: UTC
volume:
  backing: ebs
  partitions:
    type: msdos
    root:
      filesystem: ext4
      size: 8GiB
packages:
  mirror: http://cloudfront.debian.net/debian
#TODO remove?  install:
#TODO remove?    - ca-certificates
#TODO remove?    - bootlogd
#TODO remove?    - sysvinit
#TODO remove?    - systemd
#TODO remove?    - systemd-sysv
#TODO remove?    - cloud-initramfs-growroot # necessary because no cloud-init?
#TODO remove?    - logrotate
plugins:
#TODO remove?  cloud_init:
#TODO remove?    metadata_sources: Ec2
#TODO remove?    username: admin
  ntp: {}
  commands:
    commands:
       # Install docker 1.9.1
       - [ 'wget', '-nv', 'http://apt.dockerproject.org/repo/pool/main/d/docker-engine/docker-engine_1.9.1-0~jessie_amd64.deb', '-O', '{root}/tmp/docker.deb' ]
       - [ '/bin/sh', '-c', 'cd {root}/tmp; echo "c58c39008fd6399177f6b2491222e4438f518d78  docker.deb" | shasum -c -' ]
       - [ 'chroot', '{root}', '/bin/sh', '-c', 'DEBIAN_FRONTEND=noninteractive dpkg --install /tmp/docker.deb' ]
       - [ 'chroot', '{root}', '/bin/sh', '-c', 'DEBIAN_FRONTEND=noninteractive apt-get install -f --no-install-recommends --assume-yes' ]
       - [ 'rm', '{root}/tmp/docker.deb' ]

       # Fix a cloud-init bug where it uses nobootwait
       # see https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=789884
#TODO remove?       - [ 'chroot', '{root}', '/bin/sh', '-c', 'echo "mount_default_fields: [~, ~, ''auto'', ''defaults,nofail'', ''0'', ''2'']" > /etc/cloud/cloud.cfg.d/99_kubernetes.cfg' ]

       # We perform a full replacement of some grub conf variables:
       #   GRUB_CMDLINE_LINUX_DEFAULT (add memory cgroup)
       #   GRUB_TIMEOUT (remove boot delay)
       # (but leave the old versions commented out for people to see)
       - [ 'chroot', '{root}', 'touch', '/etc/default/grub' ]
       - [ 'chroot', '{root}', 'sed', '-i', 's/^GRUB_CMDLINE_LINUX_DEFAULT=/#GRUB_CMDLINE_LINUX_DEFAULT=/g', '/etc/default/grub' ]
       - [ 'chroot', '{root}', 'sed', '-i', 's/^GRUB_TIMEOUT=/#GRUB_TIMEOUT=/g', '/etc/default/grub' ]
       - [ 'chroot', '{root}', '/bin/sh', '-c', 'echo "# kubernetes image changes" >> /etc/default/grub' ]
       - [ 'chroot', '{root}', '/bin/sh', '-c', 'echo "GRUB_CMDLINE_LINUX_DEFAULT=\"cgroup_enable=memory oops=panic panic=10 console=ttyS0\"" >> /etc/default/grub' ]
       - [ 'chroot', '{root}', '/bin/sh', '-c', 'echo "GRUB_TIMEOUT=0" >> /etc/default/grub' ]
       - [ 'chroot', '{root}', 'update-grub2' ]

       # install kubelet
       - [ 'mkdir', '-p', '{root}/usr/local/sbin', '{root}/etc/systemd/system' ]
       - [ 'wget', '-nv', '-O', '{root}/usr/local/sbin/kubelet', 'https://storage.googleapis.com/kubernetes-release/release/v1.2.0/bin/linux/amd64/kubelet' ]
       #TODO check hash of kubelet binary
       - [ 'chmod', '0755', '{root}/usr/local/sbin/kubelet' ]
       - [ 'cp', 'kubelet.service', '{root}/etc/systemd/system/kubelet.service' ]
       - [ 'chown', 'root:root', '{root}/etc/systemd/system/kubelet.service' ]
       - [ 'chroot', '{root}', 'systemctl', 'enable', 'kubelet' ]
